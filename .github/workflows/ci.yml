name: CI for Docker Image

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    build:
        runs-on: windows-latest

        steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Log in to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name: Create Image
          run: docker build -t ${{ secrets.DOCKER_USERNAME }}/win-dev-env:latest -m 2GB .

        - name: Run Docker container
          run: docker run --rm -v "$(pwd):C:\dev" -w C:\dev ${{ secrets.DOCKER_USERNAME }}/win-dev-env:latest ./scripts/create-manifest.ps1 -OutputPath ./manifests.md

        - name: Build
          run: docker run --rm -v "$(pwd):C:\dev" -w C:\dev ${{ secrets.DOCKER_USERNAME }}/win-dev-env:latest cmake -S . -B build; cmake --build build; ctest --test-dir build -C Release

        - name: Push
          if: ${{ github.event_name == 'push' && github.ref == '/refs/heads/main' }}
          run: docker push ${{ secrets.DOCKER_USERNAME }}/win-dev-env:latest